(function(n){"use strict";if("undefined"==typeof sigma)throw new Error("sigma is not declared");sigma.utils.pkg("sigma.layout.noverlap");var s={speed:3,scaleNodes:1.2,nodeMargin:5,gridSize:20,permittedExpansion:1.1,rendererIndex:0,maxIterations:500},t={},o={};function e(){var w=this;this.init=function(n,i){if(i=i||{},this.sigInst=n,this.config=sigma.utils.extend(i,s),this.easing=i.easing,this.duration=i.duration,i.nodes&&(this.nodes=i.nodes,delete i.nodes),!sigma.plugins||void 0===sigma.plugins.animate)throw new Error("sigma.plugins.animate is not declared");this.running=!1},this.atomicGo=function(){if(!this.running||this.iterCount<1)return!1;var n,i,e,d,r,s,t,o,g,a,f,c,h,l,u,p,x,_,m,M,y,z=this.nodes||this.sigInst.graph.nodes(),v=z.length,I=1/0,E=-1/0,N=1/0,S=-1/0;for(this.iterCount--,this.running=!1,n=0;n<v;n++)(i=z[n]).dn.dx=0,i.dn.dy=0,I=Math.min(I,i.dn_x-(i.dn_size*w.config.scaleNodes+w.config.nodeMargin)),E=Math.max(E,i.dn_x+(i.dn_size*w.config.scaleNodes+w.config.nodeMargin)),N=Math.min(N,i.dn_y-(i.dn_size*w.config.scaleNodes+w.config.nodeMargin)),S=Math.max(S,i.dn_y+(i.dn_size*w.config.scaleNodes+w.config.nodeMargin));for(d=E-I,r=S-N,t=(N+S)/2,I=(s=(I+E)/2)-w.config.permittedExpansion*d/2,E=s+w.config.permittedExpansion*d/2,N=t-w.config.permittedExpansion*r/2,S=t+w.config.permittedExpansion*r/2,o={},g=0;g<w.config.gridSize;g++)for(o[g]={},a=0;a<w.config.gridSize;a++)o[g][a]=[];for(n=0;n<v;n++)for(_=(i=z[n]).dn_x-(i.dn_size*w.config.scaleNodes+w.config.nodeMargin),m=i.dn_x+(i.dn_size*w.config.scaleNodes+w.config.nodeMargin),M=i.dn_y-(i.dn_size*w.config.scaleNodes+w.config.nodeMargin),y=i.dn_y+(i.dn_size*w.config.scaleNodes+w.config.nodeMargin),f=Math.floor(w.config.gridSize*(_-I)/(E-I)),c=Math.floor(w.config.gridSize*(m-I)/(E-I)),h=Math.floor(w.config.gridSize*(M-N)/(S-N)),l=Math.floor(w.config.gridSize*(y-N)/(S-N)),a=f;a<=c;a++)for(g=h;g<=l;g++)o[g][a].push(i.id);for(u={},g=0;g<w.config.gridSize;g++)for(a=0;a<w.config.gridSize;a++)o[g][a].forEach(function(i){for(u[i]||(u[i]=[]),p=Math.max(0,g-1);p<=Math.min(g+1,w.config.gridSize-1);p++)for(x=Math.max(0,a-1);x<=Math.min(a+1,w.config.gridSize-1);x++)o[p][x].forEach(function(n){n!==i&&-1===u[i].indexOf(n)&&u[i].push(n)})});for(n=0;n<v;n++)e=z[n],u[e.id].forEach(function(n){var i=w.sigInst.graph.nodes(n),s=i.dn_x-e.dn_x,t=i.dn_y-e.dn_y,o=Math.sqrt(s*s+t*t);o<e.dn_size*w.config.scaleNodes+w.config.nodeMargin+(i.dn_size*w.config.scaleNodes+w.config.nodeMargin)&&(w.running=!0,0<o?(i.dn.dx+=s/o*(1+e.dn_size),i.dn.dy+=t/o*(1+e.dn_size)):(i.dn.dx+=.01*d*(.5-Math.random()),i.dn.dy+=.01*r*(.5-Math.random())))});for(n=0;n<v;n++)(i=z[n]).fixed||(i.dn_x=i.dn_x+.1*i.dn.dx*w.config.speed,i.dn_y=i.dn_y+.1*i.dn.dy*w.config.speed);return this.running&&this.iterCount<1&&(this.running=!1),this.running},this.go=function(){for(this.iterCount=this.config.maxIterations;this.running;)this.atomicGo();this.stop()},this.start=function(){if(!this.running){var n=this.sigInst.graph.nodes(),i=this.sigInst.renderers[w.config.rendererIndex].options.prefix;this.running=!0;for(var s=0;s<n.length;s++)n[s].dn_x=n[s][i+"x"],n[s].dn_y=n[s][i+"y"],n[s].dn_size=n[s][i+"size"],n[s].dn={dx:0,dy:0};o[w.sigInst.id].dispatchEvent("start"),this.go()}},this.stop=function(){var i=this.sigInst.graph.nodes();if(this.running=!1,this.easing)o[w.sigInst.id].dispatchEvent("interpolate"),sigma.plugins.animate(w.sigInst,{x:"dn_x",y:"dn_y"},{easing:w.easing,onComplete:function(){w.sigInst.refresh();for(var n=0;n<i.length;n++)i[n].dn=null,i[n].dn_x=null,i[n].dn_y=null;o[w.sigInst.id].dispatchEvent("stop")},duration:w.duration});else{for(var n=0;n<i.length;n++)i[n].x=i[n].dn_x,i[n].y=i[n].dn_y;this.sigInst.refresh();for(n=0;n<i.length;n++)i[n].dn=null,i[n].dn_x=null,i[n].dn_y=null;o[w.sigInst.id].dispatchEvent("stop")}},this.kill=function(){this.sigInst=null,this.config=null,this.easing=null}}sigma.prototype.configNoverlap=function(n){var i=this;if(!n)throw new Error('Missing argument: "config"');return t[i.id]||(t[i.id]=new e,o[i.id]={},sigma.classes.dispatcher.extend(o[i.id]),i.bind("kill",function(){t[i.id].kill(),t[i.id]=null,o[i.id]=null})),t[i.id].init(i,n),o[i.id]},sigma.prototype.startNoverlap=function(n){var i=this;return n&&this.configNoverlap(i,n),t[i.id].start(),o[i.id]},sigma.prototype.isNoverlapRunning=function(){return!!t[this.id]&&t[this.id].running}}).call(this);